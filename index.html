<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Komentar Merdeka</title>
<style>
:root{--merah:#d50000;--merah-tua:#b71c1c;--putih:#ffffff;}
*{box-sizing:border-box;}
html,body{margin:0;padding:0;font-family:'Segoe UI',Arial,sans-serif;}
body{color:#fff;background:url('FESTARA03.jpg') center/cover no-repeat fixed;position:relative;}
body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:-1;}
header{background:var(--merah);border-bottom:3px solid var(--putih);padding:18px 12px;text-align:center;}
header h1{margin:0;font-size:clamp(1.4rem,3.5vw,2.2rem);font-weight:800;letter-spacing:.5px;}
main{max-width:720px;margin:18px auto;padding:16px;background: rgba(255,255,255,.08);border-radius:14px;backdrop-filter: blur(2px);box-shadow:0 10px 30px rgba(0,0,0,.25);}
#formKomentar{background: rgba(255,255,255,.92); color:#222; border-radius:14px; padding:18px; box-shadow:0 8px 24px rgba(0,0,0,.35); margin:0 auto 16px; max-width:560px;}
#formKomentar input,#formKomentar textarea{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #ddd;outline:none;transition:border-color .2s ease;font-size:15px;margin-bottom:10px;}
#formKomentar input:focus,#formKomentar textarea:focus{border-color: var(--merah);}
#formKomentar textarea{min-height:110px;resize: vertical;}
#formKomentar button{width:100%;padding:12px 14px;border:none;border-radius:10px;cursor:pointer;color:#fff;font-weight:800;letter-spacing:.3px;background:linear-gradient(90deg,var(--merah),#ff1744);transition: transform .06s ease, filter .2s ease;}
#formKomentar button:hover{filter: brightness(.97);} #formKomentar button:active{transform: translateY(1px);}
h2{text-align:center;margin:10px 0 12px;font-weight:800;color:#ffebee;}
#daftarKomentar{display:grid;gap:10px;max-width:720px;margin:0 auto;}
.komentar{background: rgba(255,255,255,.92); color:#222; border-left:5px solid var(--merah); border-radius:12px; padding:12px 14px; box-shadow:0 6px 18px rgba(0,0,0,.25); overflow-wrap:anywhere; word-break:break-word; white-space:pre-wrap; position:relative;}
.meta{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px;font-size:.9rem;color:#555;}
.hapus-btn{background:var(--merah-tua);color:#fff;border:none;border-radius:8px;cursor:pointer;padding:6px 10px;font-size:.85rem;font-weight:700;transition:filter .2s ease, transform .06s ease;}
.hapus-btn:hover{filter: brightness(.95);} .hapus-btn:active{transform: translateY(1px);}
footer{text-align:center;margin:12px 0;font-size:.9rem;color:#eee;}

/* ---- menu titik tiga (preserve look of main layout) ---- */
.menu-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 34px;
  height: 34px;
  border-radius: 50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  color: rgba(0,0,0,0.65);
  background: rgba(255,255,255,0.9);
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.06);
  transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
  z-index:40;
}
.menu-btn:hover { transform: scale(1.04); box-shadow: 0 6px 14px rgba(0,0,0,0.12); }

/* popup menu: fade + scale */
.menu-popup {
  position: absolute;
  top: 48px;
  right: 10px;
  min-width: 180px;
  background: #fff;
  color: #222;
  border-radius: 10px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.18);
  transform-origin: top right;
  transform: translateY(-8px) scale(.96);
  opacity: 0;
  pointer-events: none;
  transition: transform .16s cubic-bezier(.2,.9,.3,1), opacity .16s ease;
  z-index: 60;
  overflow: hidden;
}
.menu-popup.show {
  transform: translateY(0) scale(1);
  opacity: 1;
  pointer-events: auto;
}
.menu-popup button {
  display:block;
  width:100%;
  padding:10px 12px;
  text-align:left;
  border:0;
  background:transparent;
  font-size:14px;
  cursor:pointer;
}
.menu-popup button + button { border-top:1px solid rgba(0,0,0,0.06); }
.menu-popup button:hover { background: rgba(0,0,0,0.03); }

/* replies and reply form (preserve look) */
.reply-container{margin-top:8px; display:none;}
.balasan{background: rgba(255,255,255,.95); color:#222; border-left:4px solid #ff5252; border-radius:8px; padding:10px 12px; box-shadow:0 4px 12px rgba(0,0,0,.08); margin:8px 0 0 18px; white-space:pre-wrap; position:relative;}
.reply-form{margin-top:10px; margin-left:18px; display:none;}
.reply-form input, .reply-form textarea{width: calc(100% - 12px); padding:8px; margin-bottom:8px; border-radius:8px; border:1px solid #ddd; background:#fff; color:#222;}
.reply-form button{padding:8px 12px; border-radius:8px; border:0; background:linear-gradient(90deg,var(--merah),#ff1744); color:#fff; cursor:pointer;}
.menu-note { font-size:12px; color:#666; padding:6px 12px; }

/* keep popup of reply menu small */
.reply .menu-btn { top:6px; right:8px; width:30px; height:30px; font-size:16px; background: rgba(255,255,255,0.95); }
.reply .menu-popup { top:34px; right:8px; min-width:140px; }
</style>
</head>
<body>
<header><h1>ðŸ‡®ðŸ‡© KOMENTAR FESTARA03 ðŸ‡®ðŸ‡©</h1></header>

<main>
<form id="formKomentar" autocomplete="off">
  <input type="text" id="nama" placeholder="Nama" required />
  <textarea id="isi" placeholder="Tulis komentar..." required></textarea>
  <button type="submit">Kirim</button>
</form>

<h2>Daftar Komentar</h2>
<div id="daftarKomentar"></div>
</main>

<footer>Buatan Sekbid 8</footer>

<script type="module">
/* ========= Firebase imports ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, onSnapshot, serverTimestamp,
  deleteDoc, doc, query, orderBy
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ====== Firebase config (sesuaikan jika perlu) ====== */
const firebaseConfig = {
  apiKey: "AIzaSyD8MS2ZX8MaB-VbuUmrRtN-FyEOnqExjFA",
  authDomain: "festara03.firebaseapp.com",
  databaseURL: "https://festara03-default-rtdb.firebaseio.com",
  projectId: "festara03",
  storageBucket: "festara03.firebasestorage.app",
  messagingSenderId: "415555427034",
  appId: "1:415555427034:web:c3f83ede55d952c1e7e3e3",
  measurementId: "G-G12DMSY19K"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===== keep same behavior as original code ===== */
const daftarKomentar = document.getElementById("daftarKomentar");
const form = document.getElementById("formKomentar");
const inputNama = document.getElementById("nama");
const inputIsi = document.getElementById("isi");

const ADMIN_PASSWORD = "MerahPutih2025";

/* toast (unchanged) */
function showToast(message){
  const toast = document.createElement("div");
  toast.textContent = message;
  toast.style.position="fixed";
  toast.style.bottom="20px";
  toast.style.left="50%";
  toast.style.transform="translateX(-50%)";
  toast.style.background="rgba(0,0,0,0.85)";
  toast.style.color="#fff";
  toast.style.padding="10px 16px";
  toast.style.borderRadius="8px";
  toast.style.boxShadow="0 4px 12px rgba(0,0,0,.4)";
  toast.style.zIndex="9999";
  toast.style.opacity="0";
  toast.style.transition="opacity 0.3s ease";
  document.body.appendChild(toast);
  setTimeout(()=>{toast.style.opacity="1";},50);
  setTimeout(()=>{toast.style.opacity="0"; setTimeout(()=>{toast.remove();},300);},2000);
}

/* manage reply listeners to avoid leaks */
const replyCountUnsubs = new Map();
const replyListUnsubs = new Map();
function cleanupAllReplyListeners(){
  replyCountUnsubs.forEach(fn=>{ try{ fn && fn(); }catch{} });
  replyCountUnsubs.clear();
  replyListUnsubs.forEach(fn=>{ try{ fn && fn(); }catch{} });
  replyListUnsubs.clear();
}

/* render comments: preserve original UI, add menu dot and reply features */
function renderKomentar(){
  const q = query(collection(db,"komentar"), orderBy("waktu","desc"));
  onSnapshot(q, (snap) => {
    cleanupAllReplyListeners();
    daftarKomentar.innerHTML = "";

    snap.forEach(docSnap => {
      const data = docSnap.data();
      const id = docSnap.id;
      const waktu = data?.waktu?.seconds ? new Date(data.waktu.seconds*1000).toLocaleString() : "";

      // wrapper (exact class preserved)
      const konten = document.createElement("div");
      konten.className = "komentar";

      // content (same)
      const isiDiv = document.createElement("div");
      isiDiv.textContent = `${data?.nama || "Anonim"}: ${data?.isi || data?.komen || ""}`;

      // meta (same)
      const metaDiv = document.createElement("div");
      metaDiv.className = "meta";
      const small = document.createElement("small");
      small.textContent = waktu || "â€”";

      // actions left empty (we keep markup)
      const actions = document.createElement("div");
      actions.className = "actions";

      metaDiv.appendChild(small);
      metaDiv.appendChild(actions);

      // ---- create menu button (titik tiga) and popup (minimalis) ----
      const menuBtn = document.createElement("div");
      menuBtn.className = "menu-btn";
      menuBtn.innerHTML = "â‹®";

      const menuPopup = document.createElement("div");
      menuPopup.className = "menu-popup";

      const btnBalas = document.createElement("button");
      btnBalas.textContent = "Balas";

      const btnLihat = document.createElement("button");
      btnLihat.textContent = "Lihat balasan";
      btnLihat.style.display = "none"; // show only if replies exist; label updated by count listener

      const btnHapus = document.createElement("button");
      btnHapus.textContent = "Hapus";

      menuPopup.appendChild(btnBalas);
      menuPopup.appendChild(btnLihat);
      menuPopup.appendChild(btnHapus);

      // replies container (hidden by default)
      const repliesWrap = document.createElement("div");
      repliesWrap.className = "reply-container";
      repliesWrap.id = `replies-${id}`;

      const repliesList = document.createElement("div");
      repliesList.id = `replies-list-${id}`;
      repliesWrap.appendChild(repliesList);

      const replyForm = document.createElement("div");
      replyForm.className = "reply-form";
      replyForm.style.display = "none";
      replyForm.innerHTML = `
        <input type="text" id="namaBalas-${id}" placeholder="Nama" />
        <textarea id="isiBalas-${id}" placeholder="Tulis balasan..."></textarea>
        <button id="kirimBalas-${id}">Kirim Balasan</button>
      `;
      repliesWrap.appendChild(replyForm);

      // attach menu behaviors
      menuBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        // close other popups
        document.querySelectorAll('.menu-popup.show').forEach(p => { if(p !== menuPopup) p.classList.remove('show'); });
        menuPopup.classList.toggle('show');
      });

      // clicking outside closes menus (global handler below also covers)
      // Btn Balas: open replies container and toggle form
      btnBalas.addEventListener("click", (e) => {
        e.stopPropagation();
        repliesWrap.style.display = "block";
        replyForm.style.display = replyForm.style.display === "none" ? "block" : "none";
        menuPopup.classList.remove('show');
        // update lihat button text if needed (ke "Tutup balasan" ketika terbuka)
        const currentlyOpen = repliesWrap.style.display === "block";
        if (currentlyOpen) btnLihat.textContent = `Tutup balasan`;
      });

      // send reply action
      replyForm.querySelector(`#kirimBalas-${id}`).addEventListener("click", async (ev) => {
        ev.preventDefault();
        const n = (replyForm.querySelector(`#namaBalas-${id}`).value || "").trim();
        const t = (replyForm.querySelector(`#isiBalas-${id}`).value || "").trim();
        if (!n || !t) return;
        try {
          await addDoc(collection(db, "komentar", id, "balasan"), { nama: n, isi: t, waktu: serverTimestamp() });
          replyForm.querySelector(`#namaBalas-${id}`).value = "";
          replyForm.querySelector(`#isiBalas-${id}`).value = "";
          showToast("Balasan terkirim!");
          // ensure replies visible
          repliesWrap.style.display = "block";
          replyForm.style.display = "none";
        } catch (err) {
          alert("Gagal mengirim balasan: " + (err?.message || err));
        }
      });

      // delete comment (admin password)
      btnHapus.addEventListener("click", async (e) => {
        e.stopPropagation();
        const pw = prompt("Masukkan password admin untuk hapus komentar:");
        if (pw === ADMIN_PASSWORD) {
          konten.style.transition = "opacity 0.4s ease, transform 0.4s ease";
          konten.style.opacity = "0"; konten.style.transform = "translateY(-20px)";
          setTimeout(async () => {
            try { await deleteDoc(doc(db, "komentar", id)); }
            catch (err) { alert("Gagal hapus: " + (err?.message || err)); konten.style.opacity = "1"; konten.style.transform = "translateY(0)"; }
          }, 400);
        } else {
          alert("Password salah!");
        }
        menuPopup.classList.remove('show');
      });

      // realtime count listener for replies -> update btnLihat visibility & label
      const balasanCol = collection(db, "komentar", id, "balasan");
      const countUnsub = onSnapshot(balasanCol, (balSnap) => {
        const c = balSnap.size;
        if (c > 0) {
          btnLihat.style.display = "block";
          // if repliesWrap open -> show "Tutup balasan" else "Lihat X balasan"
          const openNow = repliesWrap.style.display === "block";
          btnLihat.textContent = openNow ? `Tutup balasan` : `Lihat ${c} balasan`;
        } else {
          btnLihat.style.display = "none";
        }
      });
      replyCountUnsubs.set(id, countUnsub);

      // Lihat/Tutup balasan: toggle list and attach real-time list listener once
      let listListenerAttached = false;
      btnLihat.addEventListener("click", (e) => {
        e.stopPropagation();
        const nowOpen = repliesWrap.style.display === "block";
        if (nowOpen) {
          // close
          repliesWrap.style.display = "none";
          btnLihat.textContent = `Lihat balasan`;
          // we keep list listener active to update count, but DOM hidden
        } else {
          // open
          repliesWrap.style.display = "block";
          btnLihat.textContent = `Tutup balasan`;
          // attach real-time list if not attached
          if (!listListenerAttached) {
            const listUnsub = onSnapshot(query(balasanCol, orderBy("waktu","asc")), (snapBalas) => {
              repliesList.innerHTML = "";
              snapBalas.forEach(bdoc => {
                const b = bdoc.data();
                const waktuB = b?.waktu?.seconds ? new Date(b.waktu.seconds*1000).toLocaleString() : "";
                const row = document.createElement("div");
                row.className = "balasan";

                // content text (preserve look)
                const top = document.createElement("div");
                top.textContent = `${b?.nama || "Anonim"}: ${b?.isi || b?.komen || ""}`;

                // create menu dot for each reply (minimal, same behavior)
                const rMenuBtn = document.createElement("div");
                rMenuBtn.className = "menu-btn";
                rMenuBtn.innerHTML = "â‹®";
                // place it on row (absolutely positioned; set row position:relative)
                row.style.position = "relative";
                row.appendChild(rMenuBtn);

                const rMenuPopup = document.createElement("div");
                rMenuPopup.className = "menu-popup";
                const rBtnHapus = document.createElement("button");
                rBtnHapus.textContent = "Hapus";
                rMenuPopup.appendChild(rBtnHapus);
                row.appendChild(rMenuPopup);

                // attach rMenu behavior
                rMenuBtn.addEventListener("click", (ev)=> {
                  ev.stopPropagation();
                  // close others
                  document.querySelectorAll('.menu-popup.show').forEach(p => { if(p !== rMenuPopup) p.classList.remove('show'); });
                  rMenuPopup.classList.toggle('show');
                });

                // delete reply handler (admin pw)
                rBtnHapus.addEventListener("click", async (ev) => {
                  ev.stopPropagation();
                  const pw = prompt("Masukkan password admin untuk hapus balasan:");
                  if (pw === ADMIN_PASSWORD) {
                    row.style.transition = "opacity 0.3s ease, transform 0.3s ease";
                    row.style.opacity = "0"; row.style.transform = "translateY(-10px)";
                    setTimeout(async ()=>{
                      try { await deleteDoc(doc(db, "komentar", id, "balasan", bdoc.id)); }
                      catch (err) { alert("Gagal hapus: " + (err?.message || err)); row.style.opacity = "1"; row.style.transform = "translateY(0)"; }
                    }, 300);
                  } else alert("Password salah!");
                  rMenuPopup.classList.remove('show');
                });

                // meta area (time + small delete button exists in menu)
                const meta = document.createElement("div");
                meta.style.display="flex"; meta.style.justifyContent="space-between"; meta.style.alignItems="center"; meta.style.marginTop="6px";
                const timeEl = document.createElement("small"); timeEl.style.color="#666"; timeEl.textContent = waktuB || "â€”";
                meta.appendChild(timeEl);

                row.appendChild(top);
                row.appendChild(meta);
                repliesList.appendChild(row);
              });
            });
            replyListUnsubs.set(id, listUnsub);
            listListenerAttached = true;
          }
        }
        menuPopup.classList.remove('show');
      });

      // assemble DOM (preserve positions)
      konten.appendChild(isiDiv);
      konten.appendChild(metaDiv);
      konten.appendChild(repliesWrap);
      // put menuBtn & menuPopup as children of konten (absolute positioned)
      konten.appendChild(menuBtn);
      konten.appendChild(menuPopup);

      daftarKomentar.appendChild(konten);
    }); // end forEach
  }); // end onSnapshot
} // end renderKomentar

renderKomentar();

/* Submit komentar (preserve original behavior) */
form.addEventListener("submit", async e=>{
  e.preventDefault();
  const nama = inputNama.value.trim();
  const isi = inputIsi.value.trim();
  if (!nama || !isi) return;
  try{
    await addDoc(collection(db,"komentar"), { nama, isi, waktu: serverTimestamp() });
    inputNama.value = ""; inputIsi.value = "";
    showToast("Komentar berhasil dikirim!");
  }catch(err){
    alert("Gagal mengirim komentar: " + (err?.message || err));
  }
});

/* close menus when clicking outside */
document.addEventListener('click', (ev) => {
  if (!ev.target.closest('.menu-btn') && !ev.target.closest('.menu-popup')) {
    document.querySelectorAll('.menu-popup.show').forEach(p => p.classList.remove('show'));
  }
});
</script>
</body>
</html>
